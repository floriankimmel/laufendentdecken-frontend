---
import { getImage } from 'astro:assets';
import Layout from '../layouts/BlogPost.astro';

import { WORDPRESS_API_EPISODES_URL } from '../consts';

export async function getStaticPaths() {
    const perPage = 100;
    var page = 1;
    var loadMore = true;
    var pages = Array<any>();

    while (loadMore) {
        console.log(`Fetching page ${page} of episodes`);
        let data = await fetch(`${WORDPRESS_API_EPISODES_URL}/?per_page=${perPage}&page=${page}&_embed`)
        let episodes = await data.json();

        pages = pages.concat(
            episodes.map((episode: any) => {
                return {
                    params: { slug: episode.slug },
                    props: { episode },
                }
            })
        );

        if (episodes.length < perPage) {
            loadMore = false;
        }
        page++;
    }
    return pages;
}

const { episode } = Astro.props;

var src = episode._embedded['wp:featuredmedia']['0'].media_details.sizes.large?.source_url
if (!src) {
    src = episode._embedded['wp:featuredmedia']['0'].media_details.sizes.full.source_url
}
const optimizedImage = await getImage({
    src,
    width: 1020,
    height: 510,
    format: 'avif',
})

---

<Layout
	title={episode.title.rendered}
    description=""
	pubDate={new Date(episode.date)}
    heroImage={optimizedImage.src}
>
    <div id="player" data-slug={episode.id}></div>
    <script type="text/javascript">
        const slug = document.getElementById('player')?.getAttribute('data-slug')
        if ('podlovePlayer' in window) {
            window.podlovePlayer(
                '#player',
                `https://laufendentdecken-podcast.at/wp-json/podlove-web-player/shortcode/publisher/${slug}`,
                'https://laufendentdecken-podcast.at/wp-json/podlove-web-player/shortcode/config/podlovers/theme/default'
            );
        }
    </script>
    <Fragment set:html={episode.content.rendered} />
</Layout>
