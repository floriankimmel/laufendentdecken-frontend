---
import { type CollectionEntry } from 'astro:content';
import { getImage } from 'astro:assets';
import Layout from '../layouts/BlogPost.astro';

type Props = CollectionEntry<'blog'>;

const { slug } = Astro.params;
import { WORDPRESS_API_EPISODES_URL } from '../consts';

export async function getStaticPaths() {
  let data = await fetch(WORDPRESS_API_EPISODES_URL)
  let episodes = await data.json();

  return episodes.map((episode: any) => ({
    params: { slug: episode.slug },
    props: { post: episode },
  }));
}

const res = await fetch(`${WORDPRESS_API_EPISODES_URL}?slug=${slug}&_embed`)
const [episode] = await res.json();

const optimizedImage = await getImage({
    src: episode._embedded['wp:featuredmedia']['0'].media_details.sizes.large.source_url,
    width: 1020,
    height: 510,
    format: 'avif',
})

---

<Layout
	title={episode.title.rendered}
    description=""
	pubDate={new Date(episode.date)}
    heroImage={optimizedImage.src}
>
    <div id="player" data-slug={episode.id}></div>
    <script type="text/javascript">
        const slug = document.getElementById('player')?.getAttribute('data-slug')
        if ('podlovePlayer' in window) {
            window.podlovePlayer(
                '#player',
                `https://laufendentdecken-podcast.at/wp-json/podlove-web-player/shortcode/publisher/${slug}`,
                'https://laufendentdecken-podcast.at/wp-json/podlove-web-player/shortcode/config/podlovers/theme/default'
            );
        }
    </script>
    <Fragment set:html={episode.content.rendered} />
</Layout>
